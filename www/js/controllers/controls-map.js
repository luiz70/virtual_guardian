angular.module('starter.controllers')
.controller('controls',function($scope,$rootScope,Mapa,uiGmapIsReady,$timeout,Ubicacion,Message,socket){
	$scope.map=$rootScope.map;
	$scope.ubicacion=$rootScope.ubicacion;
	$scope.radio=$rootScope.radio;
	$scope.auto=$rootScope.auto;
	$scope.idioma=$rootScope.idioma
	$rootScope.controls=[
		{nombre:"buscar",
			id:1,
			activo:false,
			activable:false,
			content:"",
			onClick:function(){
				$rootScope.search=true;
			},
		},
		{nombre:"ubicacion",
			id:2,
			activo:false,
			activable:true,
			content:"",
			onClick:function(){
				$scope.refreshLocation();
			},
		},
		{nombre:"auto",
			id:3,
			activo:(true && $rootScope.auto.activo),
			activable:true,
			posicionando:false,
			content:"",
			onClick:function(){
			$scope.carPark();
			},
		},
		{nombre:"filtro",
			id:4,
			activo:false,
			activable:true,
			content:"",
			onClick:function(){
			Message.showModal("templates/modal/filtros.html");
			},
		},
		{nombre:"periodo",
			id:5,
			activo:false,
			activable:false,
			content:"<div class='letra-periodo'>{{$rootScope.Usuario.Periodo}}</div>",
			onClick:function(){
				var buttons=[]
				if($rootScope.Usuario.Periodo!=7)buttons.push({text:$rootScope.idioma.Periodos[7],valor:7})
				if($rootScope.Usuario.Periodo!=30)buttons.push({text:$rootScope.idioma.Periodos[30],valor:30})
				if($rootScope.Usuario.Periodo!=180)buttons.push({text:$rootScope.idioma.Periodos[180],valor:180})
				if($rootScope.Usuario.Periodo!=365)buttons.push({text:$rootScope.idioma.Periodos[365],valor:365})
				
				Message.showActionSheet($rootScope.idioma.Mapa[5],buttons,null,$rootScope.idioma.General[6],function(res,data){
					if(data)$rootScope.Usuario.Periodo=data.valor;
				})
			},
		},
	]
	$scope.controls=$rootScope.controls;
	$scope.controlClick=function(i){
		//if($scope.controls[i].activable)$scope.controls[i].activo=!$scope.controls[i].activo
		$rootScope.controls[i].onClick()
		
	}
	uiGmapIsReady.promise()
	.then(function(maps){
		$scope.mapa=$rootScope.map;
        $(".gm-style div").first().click($scope.hideControls)
        $(".gm-style div").first().mousedown($scope.hideControls)
		$scope.showControls();
	})
	$scope.showControls=function(){
		$(".contenedor-mapa-top-right").animate({
			right:"1vh"
		},200);
		$(".boton-mapa-top-right.options").animate({
		opacity:0
		},200,function(){
		});
	}
	$scope.hideControls=function(){
		$(".contenedor-mapa-top-right").animate({
			right:"-10vh"
		},400);
		$(".boton-mapa-top-right.options").animate({
		opacity:1
		},200);
	}
	$scope.refreshLocation=function(){
		$rootScope.eventosMap=[];
		Ubicacion.refreshLocation();
		
	}
	$scope.carPark=function(){
		if(!$scope.auto.activo)
			$scope.auto.posicionando=true;
		else{
			var buttons=[{text:$rootScope.idioma.Auto[5],id:1},{text:$rootScope.idioma.Auto[6],id:2},{text:$rootScope.idioma.Auto[7],id:3}]
			Message.showActionSheet($rootScope.idioma.Auto[4],buttons,null,$rootScope.idioma.General[6],function(res,data){
				if(data)
				switch(data.id){
					case 1:
						$rootScope.auto.options.visible=false;
						$rootScope.auto.options.draggable=true;
						$rootScope.auto.activo=false;
						$rootScope.controls[2].activo=false;
					break;
					case 2:
						$rootScope.auto.posicionando=true;
					break;
					case 3: 
						$rootScope.map.zoom=16;
						$rootScope.map.center={latitude:$rootScope.auto.position.latitude,longitude:$rootScope.auto.position.longitude}
					break;
				}
			})
		}
	}
	$scope.setAuto=function(){
		Message.showLoading($rootScope.idioma.Auto[8]);
		if(socket.isConnected()){
			socket.getSocket().removeListener("getAnalisisAuto",$scope.getAnalisis)
			socket.getSocket().removeListener("errorAnalisisAuto",$scope.errorAnalisis)
			socket.getSocket().on("errorAnalisisAuto",$scope.errorAnalisis)
			socket.getSocket().on("getAnalisisAuto",$scope.getAnalisis)
			socket.getSocket().emit("getAnalisisAuto",$rootScope.auto.position)
		}else{
			$scope.errorAnalisis();
		}
		//Message.showModal("templates/modal/resumen-auto.html");
	}
	$scope.getAnalisis=function(escala,eventos){
		socket.getSocket().removeListener("getAnalisisAuto",$scope.getAnalisis)
		Message.hideLoading();
		$rootScope.auto.escala=escala;
		$rootScope.auto.eventos=eventos;
		Message.showModal("templates/modal/resumen-auto.html");
	}
	$scope.errorAnalisis=function(data){
		socket.getSocket().removeListener("errorAnalisisAuto",$scope.errorAnalisis)
		Message.hideLoading();
		Message.confirm($rootScope.idioma.Auto[3],$rootScope.idioma.Auto[9],function(res){
			$rootScope.auto.posicionando=false;
			$rootScope.auto.activo=true;
			$rootScope.controls[2].activo=true;
		})
	}
	
})
.controller('top-center',function($scope,$rootScope,Mapa,uiGmapIsReady,$timeout){
	$scope.auto=$rootScope.auto
	$scope.idioma=$rootScope.idioma;
	$scope.map=$rootScope.map;
})
